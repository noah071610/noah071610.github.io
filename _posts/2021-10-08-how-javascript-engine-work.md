---
layout: post
title: ☕ 5. 자바스크립트 엔진 동작 원리 재밌게 이해하기 | 웹모르는 웹개발자
subtitle: Let's learn how Javascript engine work on the browser in a fun way.
tags: [javascript, cs, 웹모르는웹개발자]
---

<p></p>

# 자바스크립트는 어떻게 돌아갈까?

저번 웹모르는웹개발자 시리즈에서 우리는 브라우저의 렌더링 방식에 대해서 알아보았고 더 나아가서 브라우저의 자바스크립트 엔진 (V8엔진) 까지 알아보았습니다.

그렇다면 프론트엔드의 꽃, 자바스크립트는 어떻게 브라우저에서 동작할지 본격적으로 알아보겠습니다.

이번엔 특별하게 스토리 방식으로 진행해보려고 합니다.

참고로 이런 아이디어는 리덕스도 가지고있는데 조만간 리덕스 플로우도 재밌게 스토리식으로 표현해보겠습니다.

## (축) 개업을 축하드립니다.

![](https://images.unsplash.com/photo-1529022805552-1c88a713c1c5?ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8&ixlib=rb-1.2.1&auto=format&fit=crop&w=600&q=80)

개업을 축하드립니다! 당신은 `자바스크립트(JS)카페`를 열게되었습니다.

당신은 사장으로서 이 JS카페를 성공적으로 이끌어가야합니다.

그럼 JS카페를 쭉 둘러보며 #javascript 엔진 동작 원리에 대해서 알아보겠습니다.

> 들어가기전

아무래도 재밌게 이야기 형식으로 풀어보려고 하니 이야기로 풀기힘든 부분은 넘어가거나 맥락상 어색한 부분이 있을수도있습니다.

이글은 제목에도 써놨다시피 `원리를 이해하는` 포스팅입니다. 전체적인 자바스크립트 엔진 동작 원리에만 초점을 맞추어주세요.

모든 이미지는 저작권이 없는 무료 이미지 사이트인 [https://unsplash.com/](https://unsplash.com/) 에서 가져왔거나 개인적으로 만들어 사용했음을 알려드립니다.

## JS카페 내부 살펴보기

### 손님

![](https://images.unsplash.com/photo-1556742049-0cfed4f6a45d?ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8&ixlib=rb-1.2.1&auto=format&fit=crop&w=1050&q=80)

손님은 무리로 방문한다면 함수단위로 `실행컨텍스트` 라는 고객정보를 들고 들어옵니다.

실행컨텍스트 에는 여러가지 손님에 대한 정보 (스코프체인 , This값 , 변수객체)가 함수 단위로 `렉시컬환경레코드`에 담겨져있습니다. 

근데 만약 손님이 개개인으로 들어오면 그들에 대한 정보는 어떡해야할까요?

이때는 `글로벌실행컨텍스트` 라는 서류를 확인하면됩니다.

글로벌실행컨텍스트는 우리가 개업을 하면서 폐업 할때까지 무조건 하나 가지게 될 보편적 고객정보서류라고 생각하시면 됩니다.

실행컨텍스트에 관해서는 나중에 따로 다뤄볼테니 여기서는 편하게 손님정보를 알려주는 서류라고 생각해주세요.

**참고로 실행컨텍스트는 이포스팅의 맥락상 패스한거지 정말정말정말 중요한 개념입니다.**


### 직원 (이벤트 루프) 

![](https://images.unsplash.com/photo-1549996647-190b679b33d7?ixlib=rb-1.2.1&ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8&auto=format&fit=crop&w=600&q=80)

이 친구는 매장을 계속 반복 순회하며 매장내에 일을 처리하는 JS카페의 중추적인 역할을 하는 친구입니다.

정말 대단한 친구인게 혼자서 카운터 `(콜스택)`에서 커피도 만들고, 대기실`(큐)`에 서 대기중인 손님들도 관리하고 , 리모델링팀`(렌더)`에게 리모델링 사항도 알려주고 그냥 일당백인 친구입니다. (~~JS카페의 사장인 당신은 악덕사장입니다.~~)

앞으로 매장을 운영하는데 없어서는 안될 중요한 친구가 되겠습니다.

### 카운터 (콜스택)

![](https://images.unsplash.com/photo-1449198063792-7d754d6f3c80?ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8&ixlib=rb-1.2.1&auto=format&fit=crop&w=600&q=80)

카운터`(콜스택)`에서 우리는 손님을 받을것입니다.

이벤트루프는 매장을 삥글삥글 돌며 "할거없나~" 하던중 손님이 오면 카운터에서 손님을 맞이하고 커피를 제조합니다.

카운터는 `싱글스레드` 라서 한 번에 한 명의 손님을 응대하며, 이벤트루프는 카운터에 손님이 없을때까지 다른곳으로 이동을 하지않습니다. (서비스 정신이 투철합니다.)

주의사항으로 과도하게 손님이 쌓여서 카운터가 감당 가능한 손님수를 초과하면 매장이 터져버리니 주의해주시길 바랍니다. 

![](https://t1.daumcdn.net/cfile/tistory/997266485C32157D1A)
- 끝도없는 손님들을 카운터가 감당하지 못하고 터져버렸다.

### 식자재 창고 (힙메모리)

![](https://images.unsplash.com/photo-1605371924599-2d0365da1ae0?ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8&ixlib=rb-1.2.1&auto=format&fit=crop&w=600&q=80)

식자재 창고에는 커피제조에 필요한 각종 식자재`(참조타입)` 이 보관되어있습니다.

JS카페에서는 이 창고를 `힙메모리` 라고 부르기로 했습니다.

앞으로 우리는 커피를 만들때 필요한 식자재를 창고에서 `참조` 해서 가져옵니다.

객체 , 배열 , 함수 등이 참조타입인데요.

예를들어 `const JS카페특제쿠키 = "이미완성되있음"` 같은 원시타입은 이미 완성되어 있기때문에 카운터(콜스택) 옆에 두어, 주문시 이벤트루프가 바로 처리하지만. (원시타입은 콜스택에 저장됩니다. 실행컨텍스트와 관련있으나 고증상 패스)

`const JS아이스아메리카노 = ['물','얼음','에스프레소']` 같이 조제를 해야되는 참조타입이라면 힙메모리 창고에서 가져와서 쓰는것입니다.

식자재창고(힙메모리)는 동적으로 크기가 변하는 식자재(참조타입)를 보관합니다. 여러가지 식자재들을 사용하다보면 굉장히 동적으로 수량이 줄었다가 늘었다 하겠죠?

예를들어 참조타입인 배열의 경우 push() pop()등으로 동적으로 변화를 주기때문에 따로 힙메모리에 넉넉한 주소를 미리 확보해두어 동적인 데이터값 변화에 대응합니다. 바로 그런 맥락입니다.

### 에이전시 (web api)

![](https://images.unsplash.com/photo-1580643735948-c52d25d9c07d?ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8&ixlib=rb-1.2.1&auto=format&fit=crop&w=600&q=80)

이벤트루프는 카운터(콜스택)에서 한명의 손님이 무리한 부탁 `(무리한 연산)`을 해도 그 응대를 계속 들어줍니다. `(단일 호출 스택)`

악덕사장인 당신은 회전율 때문에 이게 영 못마땅했고 `(JS는 다중스레드가 아니다)` 그래서 `web api` 라는 에이전시를 두었습니다. `(동시성 지원)`

예를들어 

```javascript
setTimeout(()=>{
  console.log('손님 주문하신 커피 나왔습니다')
},60000)
```

setTimeout 같은 비동기 손님은 에이전시가 web api 입니다.

그러므로 카운터(콜스택)에서 주구장창 기다리지않고 일단 web api 에이전시에게 양도합니다.

그리고 web api는 1분동안 손님을 대신 맡아줍니다. 뭐하면서 기다릴까요? ~~푸른 하늘 은하수 하얀 쪽배엔~~~

그리고 1분뒤 이 손님을 손님 대기실 `(Macro Task Queue)` 로 넣어줍니다.

`AJAX`같은 비동기 HTTP 프로토콜도 마찬가지입니다. 

값을 가져오기 위해 시간이 얼마나 소모될지 알수없는 무서운 손님이라 카운터에서 많이 허비해 손님들이 화내기 전에, 에이전시가 잠시 맡아주고 데이터를 받고 다시 오는것입니다.

에이전시가 `web api` 인 비동기는 setTimeout , setInterval , setImmediate , requestAnimationFrame , I/O , UI 렌더링 등이 있습니다.

참고로 `Promise` 는 같은 비동기이지만 web api로 가지않습니다. 이건 나중에 설명드리겠습니다.

### 일반 손님 대기실 (Macro Task Queue)

web api 에이전시가 맡아준 손님은 약속된 시간이 끝나면 일반 손님 대기실인 `Macro Task Queue` 에 넣어준다고 말씀드렸습니다.

이곳에 손님들은 대기를 하면서 다시 카운터 `(콜스택)` 으로 갈 준비를 합니다.

하지만 혼자서 이동할수없고 직원`(이벤트루프)`가 불러줘야지 갈 수 있습니다.

이벤트 루프는 삥글삥글 매장을 순회하는 친구라고 말씀드렸죠? 그 친구를 기다리는 것 입니다.

원래 유럽 신사들은 웨이터를 부르는건 신사적이지 않다고 합니다. 그래서 이 신사적인 손님은 웨이터를 부르지않고 점잖게 기다리는건가봅니다.

![](https://images.unsplash.com/photo-1601221018879-1286bba486f2?ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8&ixlib=rb-1.2.1&auto=format&fit=crop&w=600&q=80)

이벤트루프가 도착했습니다. 이제 카운터로 다시 가면 되는데요,

가게지침에 따라서 이벤트루프는 한번의 순회당 한명씩 데리고 갑니다. 

즉 3명의 손님이 일반 손님 대기실 (Macro Task Queue) 에서 대기중이면, 순번이 빠른 손님 1명만 `FIFO (선입선출)` 만 먼저 데려갑니다.

그렇게 남은 2명의 신사 손님들은 그렇게 또 점잖게 기다리기 시작합니다.

### 특별 손님 대기실 (Micro Task Queue)

여기는 일반적인 일반 손님 대기실 (Macro Task Queue) 이랑은 사뭇 다릅니다.

일전에 카운터 `(콜스택)` 에서 넘겨준 `promise` 또는 wep api 에이전시에서 넘겨준 `observe` 등의 VIP손님이 머무르는 곳입니다.

이분들은 VIP이시기 때문에 카운터(콜스택)에서 길게 기다릴 필요가 없습니다.

깔끔하게 정돈된 특별 손님 대기실에서 잠시 기다리시게 한 후, 카운터가 비게 되면 모셔옵니다. 또한 우선순위가 일반 손님 대기실 (Macro Task Queue) 보다 높습니다.

> 이벤트루프야, VIP손님이 오래 기다리시면 안되니까 한번에 다 모셔와

JS카페 사장인 당신의 오더를 들은 이벤트루프는 카운터에서 손님을 다 처리 한 후 특별 대기실에 방문합니다.

특징은 일반 손님 대기실 `Macro Task Queue` 처럼 한명씩 모셔오는 것이 아니라, 한분 한분 대기실이 빌때까지 그자리에서 전부 안내 해드립니다.

물론 Micro Task "Queue" 이기때문에 이때도 먼저온 순서대로 처리합니다.

VIP (micro Task Queue로 들어가는 함수) 는 promise , observe 등이 있습니다.

### 리모델링팀 (렌더)

![](https://images.unsplash.com/photo-1569496736555-47c448d556f7?ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8&ixlib=rb-1.2.1&auto=format&fit=crop&w=600&q=80)

JS카페는 자주 리모델링을 해서 특별히 리모델링팀을 따로 고용해 매장 한켠에서 관리하고있습니다.

카운터 `(콜스택)` 에서 리모델링팀에 따로 무언가를 요청을 하면 `(리렌더링)` 이벤트루프는 그 내용을 가지고 매장을 순회합니다.

그리고 리모델링팀과 마주치면 그제서야 그 내용을 전달하고 리모델링팀은 그때 리렌더링을 시작합니다.

> 하지만 이벤트루프는 바쁘다

이벤트 루프는 대기실도 가야하고 카운터에서 손님도 봐야되고 여러모로 할게 많습니다.

그래서 일단 카운터에서 리모델링 요청서를 받아도 카운터에 손님이 없을때 까지 리모델링 요청서를 전달하러 가지 않습니다.

그리고 리모델링팀은 대략 60fps 정도의 텀을 두고 방문합니다.

이는 16.7 ms 당 한번 방문한다는 의미입니다. 

애니메이션에서 프레임 개념 잘아시죠? 부드러운 동작 이미지를 위한 시간이라고 생각하시면 편합니다.

> Request Animation Frame

`Request Animation Frame` 은 특별 리모델링 요청서입니다.

리모델링팀에게 중요한 리모델링이라고 언지를 주는 것인데요.

렌더링 할때 Render Tree 부터 Paint 까지 과정은 잘 아시죠? (브라우저 렌더링에 관해서는 저번에 웹모르는웹개발자 에 포스팅 해놨으니 그부분을 참고해주시길 바랍니다.)

이 특별 리모델링 요청서는 일반 요청과는 다르게 Redner Tree 이전에 변경이 일어납니다.

즉 일반적인 animation 보다 우선순위가 높기때문에 좀 더 부드러운 동작을 기대 할 수 있습니다.

## 이제 손님을 받아보자!

```javascript

const 주문 = document.querySelector(".주문");
  주문.addEventListener("click", () => {
    window.alert("손님 받기 시작");
    손님받기();
  });
const JS카페내부 = document.querySelector("body");

function 벽지리모델링(페인트색) {
  // 이벤트루프는 카운터에서 손님을 다 처리할때까지 나오지 않는다. 그러므로 리모델링 (벽지를 pink색으로 바꾸는 작업)은 손님받기()가 다 끝난 다음에 이루어 진다.
  JS카페내부.style.background = 페인트색;

  // 이부분은 벽지가 바뀌기 전 먼저 실행된다.
  window.alert("직원 : 리모델링 접수 완료했습니다. 손님받기가 다 끝나고 전달할게요");
}

function 손님받기() {
  // 손님이 손님받기(함수) 단위로 카운터(콜스택)으로 들어온다.
  // 이때 실행컨텍스트의 렉시컬환경 정보도 포함되어 들어온다.
  const VIP손님 = function vip() {
    // 일단 특별 대기실로 안내해드리자.
    return new Promise((resolve, reject) => {
      try {
        resolve("VIP손님 : 늘 먹던걸로");
      } catch (err) {
        reject("직원 : 손님 잠시 문제가 발생했습니다... ㅠ");
      }
    });
  };
  window.alert(`손님 : "자바" 칩프라푸치노 하나요`);
  setTimeout(() => {
    // 이손님은 에이전시(web api)로 넘겨준다.
    // 7초뒤 에이전시는 이 손님을 일반 손님 대기실 (Macro Task Queue)에 넣어주고 이벤트루프가 손님받기를 끝내고 약속된 시간에 데리고 올것이다.
    window.alert("web api 손님 : 여기 햄버거도 파나요?");
  }, 7000);
  window.alert("손님 : 뜨거운 아이스아메리카노 한잔이요.");
  window.alert("손님 : 물에 에스프레소 타고 얼음 넣은거 한잔이요");

  VIP손님()
    .then((res) => {
    // 아무리 VIP손님이라도 먼저 온 손님이 우선이기 때문에, 이벤트루프가 손님받기를 끝내고 특별 손님 대기실 (Micro Task Queue) 에서 일반 손님 대기실보다 먼저 불러올 것이다.
    window.alert(res);
  })
    .catch((err) => {
    window.alert(err);
  });
  벽지리모델링("pink");
}

```

![](https://images.velog.io/images/noah071610/post/cb136352-8730-4d31-8c2d-ff76fa1dfdd4/%EB%85%B9%ED%99%94_2021_09_14_07_07_38_617.gif)

# 마치며

이로서 자바스크립트 엔진의 동작원리를 살펴보았습니다.

서두에서 이미 말씀드렸다시피, 재밌게 이야기 형식으로 풀어보려고 하니 이야기로 풀어내기힘든 부분은 넘어가거나 맥락상 어색한 부분이 있을수도있습니다.

이글은 제목에도 써놨다시피 `원리를 이해하는` 포스팅입니다. 전체적인 자바스크립트 엔진 동작 원리에만 초점을 맞추어주세요.

그리고 피드백 있으시면 댓글로 꼭 알려주세요.

